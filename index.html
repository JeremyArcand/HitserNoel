<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Hitster No√´l - Version joueurs & podium</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --red: #b63830;
      --dark-red: #8e2923;
      --green: #1f7a4d;
      --bg: #fdf7ec;
      --card-bg: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      text-align: center;
      margin: 0;
      padding: 24px 12px 40px;
      min-height: 100vh;
      color: var(--red);
      background: radial-gradient(circle at top, #ffe7de 0, #fdf7ec 45%, #e8f4ef 100%);
    }

    h1 {
      font-size: 2rem;
      margin: 4px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    h2 {
      font-size: 1.1rem;
      margin: 0 0 18px;
      color: #7f8c8d;
    }

    #card {
      max-width: 520px;
      margin: 0 auto;
      padding: 22px 18px 26px;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.12);
      position: relative;
      overflow: hidden;
    }

    /* Progression du jeu */
    #game-progress-container {
      margin-bottom: 10px;
    }

    #game-progress-bar {
      width: 100%;
      max-width: 380px;
      height: 12px;
      background: #ecf0f1;
      border-radius: 999px;
      margin: 0 auto 5px auto;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.04);
    }

    #game-progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--green), #27ae60);
      transition: width 0.25s ease-out;
    }

    #game-progress-label {
      font-size: 0.95rem;
      color: #7f8c8d;
    }

    /* Choix nombre de chansons */
    #rounds-container {
      margin: 8px auto 10px;
      font-size: 0.9rem;
      color: #7f8c8d;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    #rounds-container span {
      font-weight: 600;
      color: var(--red);
    }

    #round-count-input {
      width: 70px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #dcdcdc;
      font-size: 0.9rem;
      text-align: center;
    }

    /* Difficult√© */
    #difficulty-container {
      margin: 6px auto 14px;
      font-size: 0.9rem;
      color: #7f8c8d;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
      justify-content: center;
      align-items: center;
      max-width: 420px;
    }

    #difficulty-container span {
      font-weight: 600;
      color: var(--red);
    }

    #difficulty-container label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    #difficulty-container input[type="radio"] {
      accent-color: var(--red);
      cursor: pointer;
    }

    #round-label {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    #duration-label {
      margin-top: 2px;
      font-size: 0.95rem;
      color: #7f8c8d;
    }

    /* Barre de progression de l'extrait */
    #progress-container {
      margin-top: 16px;
      margin-bottom: 6px;
      text-align: center;
    }

    #progress-bar {
      width: 100%;
      max-width: 380px;
      height: 9px;
      background: #ecf0f1;
      border-radius: 999px;
      margin: 0 auto;
      overflow: hidden;
    }

    #progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--red), var(--dark-red));
      transition: width 0.12s linear;
    }

    #time-label {
      font-size: 0.9rem;
      color: #7f8c8d;
      margin-top: 6px;
    }

    /* Volume */
    #volume-control {
      margin-top: 14px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    #volume-slider {
      width: 160px;
    }

    #volume-icon {
      font-size: 1.3rem;
      cursor: pointer;
    }

    audio {
      margin-top: 8px;
      width: 100%;
      max-width: 380px;
    }

    .buttons {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: stretch;
    }

    button {
      border: none;
      padding: 11px 18px;
      border-radius: 999px;
      font-size: 1rem;
      cursor: pointer;
      background: var(--red);
      color: white;
      min-width: 180px;
      font-weight: 500;
      box-shadow: 0 3px 8px rgba(0,0,0,0.18);
      transition: transform 0.05s ease-out, box-shadow 0.05s ease-out, background 0.15s;
      touch-action: manipulation;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    button.secondary {
      background: #ecf0f1;
      color: var(--red);
      border: 1px solid rgba(192,57,43,0.5);
      box-shadow: none;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    #answer {
      margin-top: 18px;
      font-size: 1.02rem;
      font-weight: 600;
    }

    .hidden {
      display: none;
    }

    /* Section joueurs */
    #players-section {
      margin-top: 22px;
      border-top: 1px solid #ecf0f1;
      padding-top: 16px;
      text-align: left;
    }

    #players-section h3 {
      margin: 0 0 8px;
      font-size: 1.05rem;
      text-align: center;
    }

    #add-player {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    #player-name-input {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #dcdcdc;
      min-width: 150px;
      font-size: 0.9rem;
    }

    #add-player-btn {
      padding: 7px 14px;
      font-size: 0.9rem;
      min-width: auto;
      box-shadow: none;
    }

    #players-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 200px;
      overflow-y: auto;
    }

    .player-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 6px 8px;
      border-radius: 10px;
      background: #f8f4f1;
    }

    .player-main {
      display: flex;
      flex-direction: column;
    }

    .player-name {
      font-weight: 600;
    }

    .player-score {
      font-size: 0.85rem;
      color: #7f8c8d;
    }

    .player-buttons {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .player-buttons button {
      padding: 5px 9px;
      font-size: 0.8rem;
      min-width: auto;
      box-shadow: none;
    }

    /* Podium */
    #podium-section {
      margin-top: 18px;
      border-top: 1px dashed #ecf0f1;
      padding-top: 10px;
      text-align: center;
    }

    #podium-section h3 {
      margin: 0 0 8px;
      font-size: 1.05rem;
    }

    #podium-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.95rem;
    }

    .podium-line {
      padding: 4px 6px;
      border-radius: 8px;
    }

    .podium-1 {
      font-weight: 700;
      background: rgba(241, 196, 15, 0.18);
    }

    .podium-2 {
      font-weight: 600;
      background: rgba(189, 195, 199, 0.18);
    }

    .podium-3 {
      font-weight: 500;
      background: rgba(205, 127, 50, 0.18);
    }

    @media (min-width: 600px) {
      body {
        padding-top: 50px;
      }
      h1 {
        font-size: 2.3rem;
      }
      h2 {
        font-size: 1.2rem;
      }
      #card {
        padding: 26px 28px 30px;
        border-radius: 22px;
      }
      .buttons {
        flex-direction: row;
        justify-content: center;
      }
      .buttons button {
        flex: 1;
        max-width: 190px;
      }
      #players-section {
        text-align: center;
      }
      #players-list {
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <h1>üéÑ Hitster No√´l üéÑ</h1>
  <h2>Mode al√©atoire</h2>

  <div id="card">

    <!-- Progression du jeu -->
    <div id="game-progress-container">
      <div id="game-progress-bar">
        <div id="game-progress-fill"></div>
      </div>
      <div id="game-progress-label">0 / 0 chansons</div>
    </div>

    <!-- Choix nombre de chansons -->
    <div id="rounds-container">
      <span>Chansons dans la partie :</span>
      <input type="number" id="round-count-input" min="1" max="22" value="22">
    </div>

    <!-- Difficult√© -->
    <div id="difficulty-container">
      <span>Niveau :</span>
      <label><input type="radio" name="difficulty" value="easy" checked> Facile</label>
      <label><input type="radio" name="difficulty" value="medium"> Moyen</label>
      <label><input type="radio" name="difficulty" value="hard"> Difficile</label>
      <label><input type="radio" name="difficulty" value="extreme"> Extr√™me</label>
    </div>

    <div id="round-label">Chanson 1</div>
    <div id="duration-label">Dur√©e : --:--</div>

    <!-- Barre de progression extrait -->
    <div id="progress-container">
      <div id="progress-bar">
        <div id="progress-fill"></div>
      </div>
      <div id="time-label">0:00 / 0:00</div>
    </div>

    <!-- Volume -->
    <div id="volume-control">
      <span id="volume-icon">üîä</span>
      <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="1">
    </div>

    <audio id="player"></audio>

    <div class="buttons">
      <button id="new-song-btn">Nouvelle chanson al√©atoire</button>
      <button id="play-btn">‚ñ∂Ô∏è Jouer</button>
      <button id="reveal-btn" class="secondary">R√©v√©ler le titre & l'artiste</button>
    </div>

    <div id="answer" class="hidden">
      Titre : <span id="answer-title"></span><br>
      Artiste : <span id="answer-artist"></span>
    </div>

    <!-- Section joueurs -->
    <div id="players-section">
      <h3>Joueurs</h3>
      <div id="add-player">
        <input type="text" id="player-name-input" placeholder="Nom du joueur">
        <button id="add-player-btn" type="button">Ajouter</button>
      </div>
      <div id="players-list"></div>
    </div>

    <!-- Podium final -->
    <div id="podium-section" class="hidden">
      <h3>üèÜ Podium de la partie</h3>
      <div id="podium-content"></div>
    </div>

  </div>

  <script>
    /* === CHANSONS === */
    const songs = [
      { file: "01_all_i_want.mp3", title: "All I Want for Christmas Is You", artist: "Mariah Carey" },
      { file: "02_last_christmas.mp3", title: "Last Christmas", artist: "Wham!" },
      { file: "03_jingle_bell_rock.mp3", title: "Jingle Bell Rock", artist: "Bobby Helms" },
      { file: "04_santa_tell_me.mp3", title: "Santa Tell Me", artist: "Ariana Grande" },
      { file: "05_underneath_the_tree.mp3", title: "Underneath the Tree", artist: "Kelly Clarkson" },
      { file: "06_mistletoe.mp3", title: "Mistletoe", artist: "Justin Bieber" },
      { file: "07_snowman.mp3", title: "Snowman", artist: "Sia" },
      { file: "08_santa's_coming_for_us.mp3", title: "Santa's Coming for Us", artist: "Sia" },
      { file: "09_it's_beginning_to_look_a_lot_like_christmas.mp3", title: "It's Beginning to Look a Lot Like Christmas", artist: "Michael Bubl√©" },
      { file: "10_rockin'_around_the_christmas_tree.mp3", title: "Rockin' Around the Christmas Tree", artist: "Brenda Lee" },
      { file: "11_it's_the_most_wonderful_time_of_the_year.mp3", title: "It's the Most Wonderful Time of the Year", artist: "Andy Williams" },
      { file: "12_wonderful_christmastime.mp3", title: "Wonderful Christmastime", artist: "Paul McCartney" },
      { file: "13_happy_xmas.mp3", title: "Happy Xmas (War Is Over)", artist: "John Lennon" },
      { file: "14_step_into_christmas.mp3", title: "Step Into Christmas", artist: "Elton John" },
      { file: "15_feliz_navidad.mp3", title: "Feliz Navidad", artist: "Jos√© Feliciano" },
      { file: "16_let_it_snow.mp3", title: "Let It Snow! Let It Snow! Let It Snow!", artist: "Dean Martin" },
      { file: "17_the_christmas_song.mp3", title: "The Christmas Song", artist: "Nat King Cole" },
      { file: "18_here_comes_santa_clause.mp3", title: "Here Comes Santa Claus", artist: "Gene Autry" },
      { file: "19_silver_bells.mp3", title: "Silver Bells", artist: "Dean Martin" },
      { file: "20_make_it_to_christmas.mp3", title: "Make It to Christmas", artist: "Alessia Cara" },
      { file: "21_a_holly_jolly_christmas.mp3", title: "A Holly Jolly Christmas", artist: "Burl Ives" },
      { file: "22_christmas.mp3", title: "Christmas (Baby Please Come Home)", artist: "Mariah Carey" }
    ];

    const audio = document.getElementById('player');
    const volumeSlider = document.getElementById('volume-slider');
    const volumeIcon = document.getElementById('volume-icon');
    const playBtn = document.getElementById('play-btn');
    const newSongBtn = document.getElementById('new-song-btn');
    const revealBtn = document.getElementById('reveal-btn');

    const roundLabel = document.getElementById('round-label');
    const durationLabel = document.getElementById('duration-label');
    const progressFill = document.getElementById('progress-fill');
    const timeLabel = document.getElementById('time-label');

    const gameProgressFill = document.getElementById('game-progress-fill');
    const gameProgressLabel = document.getElementById('game-progress-label');

    const roundsInput = document.getElementById('round-count-input');

    const answerDiv = document.getElementById('answer');
    const answerTitle = document.getElementById('answer-title');
    const answerArtist = document.getElementById('answer-artist');

    const difficultyRadios = document.querySelectorAll('input[name="difficulty"]');

    const playerNameInput = document.getElementById('player-name-input');
    const addPlayerBtn = document.getElementById('add-player-btn');
    const playersListDiv = document.getElementById('players-list');

    const podiumSection = document.getElementById('podium-section');
    const podiumContent = document.getElementById('podium-content');

    let difficulty = "easy";
    let currentSongIndex = null;
    let isPlaying = false;

    let remainingIndexes = songs.map((_, i) => i);
    let playedCount = 0;
    let maxRounds = songs.length;
    const totalSongs = songs.length;
    let gameEnded = false;

    let segmentStart = 0;
    let segmentEnd = null;
    let fadeInterval = null;
    let autoPlayAfterLoad = false;

    // Joueurs
    let players = [];

    /* === Joueurs === */
    function renderPlayers() {
      playersListDiv.innerHTML = "";
      players.forEach((p, idx) => {
        const row = document.createElement('div');
        row.className = 'player-row';

        const main = document.createElement('div');
        main.className = 'player-main';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'player-name';
        nameSpan.textContent = p.name;

        const scoreSpan = document.createElement('span');
        scoreSpan.className = 'player-score';
        scoreSpan.textContent = `${p.score} pts`;

        main.appendChild(nameSpan);
        main.appendChild(scoreSpan);

        const btns = document.createElement('div');
        btns.className = 'player-buttons';

        const btnPlus = document.createElement('button');
        btnPlus.textContent = "+1";
        btnPlus.dataset.idx = idx;
        btnPlus.dataset.type = "plus";

        const btnMinus = document.createElement('button');
        btnMinus.textContent = "-1";
        btnMinus.dataset.idx = idx;
        btnMinus.dataset.type = "minus";

        btns.appendChild(btnPlus);
        btns.appendChild(btnMinus);

        row.appendChild(main);
        row.appendChild(btns);
        playersListDiv.appendChild(row);
      });
    }

    addPlayerBtn.addEventListener('click', () => {
      const name = playerNameInput.value.trim();
      if (!name) return;
      players.push({ name, score: 0 });
      playerNameInput.value = "";
      renderPlayers();
    });

    playerNameInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') addPlayerBtn.click();
    });

    playersListDiv.addEventListener('click', e => {
      if (e.target.tagName !== 'BUTTON') return;
      const idx = parseInt(e.target.dataset.idx, 10);
      const type = e.target.dataset.type;
      if (Number.isNaN(idx) || !players[idx]) return;

      if (type === 'plus') players[idx].score += 1;
      if (type === 'minus') players[idx].score = Math.max(0, players[idx].score - 1);

      renderPlayers();
    });

    /* === Volume === */
    volumeSlider.addEventListener('input', () => {
      audio.volume = volumeSlider.value;
      updateVolumeIcon();
    });

    function updateVolumeIcon() {
      if (audio.volume == 0) volumeIcon.textContent = "üîá";
      else if (audio.volume < 0.5) volumeIcon.textContent = "üîâ";
      else volumeIcon.textContent = "üîä";
    }

    volumeIcon.addEventListener('click', () => {
      if (audio.volume > 0) {
        volumeSlider.dataset.prev = audio.volume;
        audio.volume = 0;
        volumeSlider.value = 0;
      } else {
        audio.volume = volumeSlider.dataset.prev || 1;
        volumeSlider.value = audio.volume;
      }
      updateVolumeIcon();
    });

    /* === Difficult√© === */
    difficultyRadios.forEach(r => {
      r.addEventListener('change', () => difficulty = r.value);
    });

    function getClipLength() {
      switch (difficulty) {
        case "medium": return 12;
        case "hard": return 7;
        case "extreme": return 3;
        default: return null;
      }
    }

    /* === Rounds (nombre de chansons) === */
    roundsInput.addEventListener('input', () => {
      if (playedCount > 0) return; // on ne change pas en cours de partie
      let val = parseInt(roundsInput.value, 10);
      if (Number.isNaN(val)) val = totalSongs;
      if (val < 1) val = 1;
      if (val > totalSongs) val = totalSongs;
      roundsInput.value = val;
      maxRounds = val;
      updateGameProgress();
    });

    /* === Progression jeu / audio === */
    function updateGameProgress() {
      gameProgressLabel.textContent = `${playedCount} / ${maxRounds} chansons`;
      const percent = maxRounds ? (playedCount / maxRounds) * 100 : 0;
      gameProgressFill.style.width = `${Math.min(100, percent)}%`;
    }

    function resetAudioProgress() {
      progressFill.style.width = "0%";
      timeLabel.textContent = "0:00 / 0:00";
    }

    function updateAudioProgress() {
      if (!audio.duration || segmentEnd == null) return;
      const total = segmentEnd - segmentStart;
      const elapsed = Math.max(0, audio.currentTime - segmentStart);
      if (elapsed >= total) {
        handleClipEnded();
        return;
      }
      progressFill.style.width = (elapsed / total * 100) + "%";
      timeLabel.textContent = formatTime(elapsed) + " / " + formatTime(total);
    }

    function formatTime(sec) {
      sec = Math.floor(sec);
      return Math.floor(sec / 60) + ":" + String(sec % 60).padStart(2, "0");
    }

    function clearFade() {
      if (fadeInterval) {
        clearInterval(fadeInterval);
        fadeInterval = null;
      }
    }

    /* === Segment al√©atoire === */
    function computeSegment() {
      const full = audio.duration;
      const len = getClipLength();
      if (!len || len >= full) {
        segmentStart = 0;
        segmentEnd = full;
      } else {
        const maxStart = Math.max(0, full - len);
        segmentStart = Math.random() * maxStart;
        segmentEnd = segmentStart + len;
      }
    }

    /* === Fade-in === */
    function playWithFade(resetToStart) {
      clearFade();
      try { audio.volume = 0; } catch(e){}

      if (resetToStart) audio.currentTime = segmentStart;

      audio.play().then(() => {
        isPlaying = true;
        playBtn.textContent = "‚è∏Ô∏è Pause";

        let step = 0;
        fadeInterval = setInterval(() => {
          if (!isPlaying) {
            clearFade();
            return;
          }
          step++;
          const vol = Math.min(1, step / 20);
          try { audio.volume = vol; } catch(e){}
          if (step >= 20) clearFade();
        }, 40);
      }).catch(err => console.log("Lecture bloqu√©e :", err));
    }

    /* === Fin de partie & podium === */
    function endGame() {
      if (gameEnded) return;
      gameEnded = true;
      audio.pause();
      isPlaying = false;
      playBtn.disabled = true;
      newSongBtn.disabled = true;
      roundLabel.textContent = "Partie termin√©e üéâ";
      durationLabel.textContent = "Merci d'avoir jou√© !";

      podiumContent.innerHTML = "";
      if (players.length === 0) {
        const msg = document.createElement('div');
        msg.textContent = "Aucun joueur ajout√©.";
        podiumContent.appendChild(msg);
      } else {
        const sorted = [...players].sort((a, b) => b.score - a.score);
        sorted.slice(0, 3).forEach((p, index) => {
          const div = document.createElement('div');
          const place = index + 1;
          div.className = `podium-line podium-${place}`;
          div.textContent = `${place}·µâ : ${p.name} ‚Äî ${p.score} pts`;
          podiumContent.appendChild(div);
        });
      }
      podiumSection.classList.remove('hidden');
    }

    function handleClipEnded() {
      audio.pause();
      isPlaying = false;
      clearFade();
      playBtn.textContent = "‚ñ∂Ô∏è Rejouer";
      if (!Number.isNaN(segmentStart)) {
        audio.currentTime = segmentStart;
      }
    }

    /* === Tirage nouvelle chanson === */
    function pickRandomSong(autoPlay = false) {
      if (gameEnded) return;
      if (playedCount >= maxRounds) {
        endGame();
        return;
      }
      if (remainingIndexes.length === 0) {
        endGame();
        return;
      }

      const pos = Math.floor(Math.random() * remainingIndexes.length);
      const index = remainingIndexes[pos];
      remainingIndexes.splice(pos, 1);

      currentSongIndex = index;
      const song = songs[index];

      playedCount++;
      updateGameProgress();

      roundLabel.textContent = "Chanson " + playedCount;
      answerDiv.classList.add("hidden");
      answerTitle.textContent = "";
      answerArtist.textContent = "";

      audio.src = song.file;
      audio.load();

      autoPlayAfterLoad = autoPlay;

      audio.onloadedmetadata = () => {
        computeSegment();
        audio.currentTime = segmentStart;

        const total = segmentEnd - segmentStart;
        durationLabel.textContent = "Dur√©e : " + formatTime(total);
        timeLabel.textContent = "0:00 / " + formatTime(total);

        if (autoPlayAfterLoad) {
          playWithFade(false);
        }
      };
    }

    /* === Events boutons === */
    newSongBtn.addEventListener('click', () => {
      if (gameEnded) return;
      audio.pause();
      isPlaying = false;
      pickRandomSong(true);
    });

    playBtn.addEventListener('click', () => {
      if (gameEnded) return;

      if (!audio.src) {
        pickRandomSong(true);
        return;
      }

      if (!isPlaying) {
        playWithFade(false);
      } else {
        audio.pause();
        isPlaying = false;
        playBtn.textContent = "‚ñ∂Ô∏è Reprendre";
        clearFade();
      }
    });

    revealBtn.addEventListener('click', () => {
      if (currentSongIndex == null) return;
      const s = songs[currentSongIndex];
      answerTitle.textContent = s.title;
      answerArtist.textContent = s.artist;
      answerDiv.classList.remove("hidden");
    });

    audio.addEventListener('timeupdate', updateAudioProgress);

    // Init
    maxRounds = songs.length;
    roundsInput.value = maxRounds;
    updateGameProgress();
    audio.volume = 1;
    updateVolumeIcon();
  </script>
</body>
</html>
